<!DOCTYPE html>
<html lang="en" data-turbo-native="true">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
  <meta name="turbo-refresh-method" content="morph">
  <meta name="turbo-refresh-scroll" content="preserve">
  <title>Turbo Native Demo</title>

  <!-- Load Turbo directly first as fallback -->
  <script src="https://cdn.jsdelivr.net/npm/@hotwired/turbo@8.0.2/dist/turbo.es2017-esm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@hotwired/hotwire-native-bridge@1.0.0/dist/bridge.js"></script>

  <!-- Import Map with fallback CDN -->
  <script type="importmap">
    {
      "imports": {
        "@hotwired/turbo": "https://cdn.jsdelivr.net/npm/@hotwired/turbo@8.0.2/+esm",
        "@hotwired/stimulus": "https://cdn.jsdelivr.net/npm/@hotwired/stimulus@3.2.2/+esm",
        "@hotwired/hotwire-native-bridge": "https://cdn.jsdelivr.net/npm/@hotwired/hotwire-native-bridge@1.0.0/+esm"
      }
    }
  </script>

  <!-- Inline script with robust initialization -->
  <script type="module">
    // First ensure native bridge is available
    function ensureBridgeAvailable() {
      return new Promise((resolve) => {
        if (window.nativeBridge) {
          resolve();
          return;
        }

        const maxAttempts = 10;
        let attempts = 0;
        
        const checkBridge = () => {
          attempts++;
          if (window.nativeBridge) {
            resolve();
          } else if (attempts < maxAttempts) {
            setTimeout(checkBridge, 100 * attempts);
          } else {
            console.error('Native bridge not available after max attempts');
            resolve(); // Continue anyway
          }
        };
        
        checkBridge();
      });
    }

    async function initializeTurbo() {
      try {
        await ensureBridgeAvailable();
        
        // Load Turbo - try both ESM and classic versions
        let Turbo, NativeBridge;
        
        try {
          const turboModule = await import('@hotwired/turbo');
          Turbo = turboModule.Turbo;
        } catch (e) {
          console.warn('ESM Turbo load failed, falling back to classic');
          Turbo = window.Turbo;
        }

        try {
          const bridgeModule = await import('@hotwired/hotwire-native-bridge');
          NativeBridge = bridgeModule.NativeBridge;
        } catch (e) {
          console.warn('ESM Bridge load failed, falling back to classic');
          NativeBridge = window.NativeBridge;
        }

        if (!Turbo) throw new Error('Turbo not loaded');
        if (!NativeBridge) throw new Error('NativeBridge not loaded');

        console.log('Turbo version:', Turbo.version);
        console.log('NativeBridge available:', !!NativeBridge);

        // Initialize the native bridge
        NativeBridge.start();
        
        // Configure Turbo
        Turbo.session.drive = true;
        
        // Event listeners
        document.addEventListener('turbo:load', (event) => {
          console.log('Page loaded via Turbo:', event.detail.url);
          if (window.nativeBridge) {
            window.nativeBridge.pageLoaded(event.detail.url);
          }
        });

        // Confirm initialization
        if (window.nativeBridge) {
          window.nativeBridge.turboIsReady();
        } else {
          console.warn('Native bridge not available for ready notification');
        }

      } catch (error) {
        console.error('Initialization error:', error);
        if (window.nativeBridge) {
          window.nativeBridge.turboFailedToLoad(error.toString());
        }
      }
    }

    // Start initialization after brief delay to ensure bridge is injected
    setTimeout(initializeTurbo, 50);
  </script>

  <!-- Classic script fallback -->
  <script>
    if (!window.nativeBridge) {
      console.warn('Native bridge not present at page load');
    }
    
    // Fallback Turbo initialization if modules fail
    if (!window.Turbo && document.querySelector('script[type="importmap"]')) {
      console.warn('Import maps might not be supported');
      const turboScript = document.createElement('script');
      turboScript.src = 'https://cdn.jsdelivr.net/npm/@hotwired/turbo@8.0.2/dist/turbo.es5-umd.js';
      document.head.appendChild(turboScript);
    }
  </script>
</head>
<body>
  <h1>Hello from Turbo Native</h1>
  <p>This is a basic working page for Hotwire Native on Android</p>
  <a href="page2.html" data-turbo="true">Go to Page 2</a>

  <div id="loading-state" style="display: none;">
    Loading application...
  </div>

  <script>
    // Show loading state if things take too long
    setTimeout(() => {
      if (!window.Turbo) {
        document.getElementById('loading-state').style.display = 'block';
      }
    }, 1000);
  </script>
</body>
</html>
